@model Movie
@using System
@using System.Collections.Generic
@using System.Linq

@{
    ViewData["Title"] = "Details";

    var bannerSource = string.IsNullOrWhiteSpace(Model.BannerUrl)
        ? Model.PosterUrl
        : Model.BannerUrl;

    double avgRating = 0;

    if (Model.Comments != null && Model.Comments.Any(c => c.Rating > 0))
    {
        avgRating = Model.Comments
            .Where(c => c.Rating > 0)
            .Average(c => c.Rating);
    }

    var genres = string.IsNullOrWhiteSpace(Model.Genre)
        ? new List<string>()
        : Model.Genre
            .Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(g => g.Trim())
            .Where(g => !string.IsNullOrWhiteSpace(g))
            .ToList();

    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    bool isFavorite = ViewBag.IsFavorite ?? false;
}

<section class="movie-hero position-relative mb-4">
    <div class="hero-overlay rounded"></div>

    @if (!string.IsNullOrWhiteSpace(bannerSource))
    {
        <img src="@bannerSource"
             class="img-fluid rounded w-100 hero-image"
             alt="@Model.Title banner"
             onerror="this.onerror=null;this.src='https://via.placeholder.com/1920x1080?text=No+Banner';" />
    }
    else
    {
        <img src="https://via.placeholder.com/1920x1080?text=No+Banner"
             class="img-fluid rounded w-100 hero-image"
             alt="No image available"
             onerror="this.onerror=null;this.src='@Url.Content("~/images/placeholder.jpg")';" />
    }

    <div class="hero-content text-white">
        <h1 class="fw-bold text-uppercase mb-3">@Model.Title</h1>

        <div class="d-flex flex-wrap align-items-center gap-4 mb-3 hero-meta">
            <span class="d-flex align-items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-calendar-event" viewBox="0 0 16 16">
                    <path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z" />
                    <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1.5A1.5 1.5 0 0 1 16 2.5v11A1.5 1.5 0 0 1 14.5 15h-13A1.5 1.5 0 0 1 0 13.5v-11A1.5 1.5 0 0 1 1.5 1H3V.5a.5.5 0 0 1 .5-.5M1.5 2a.5.5 0 0 0-.5.5V4h14V2.5a.5.5 0 0 0-.5-.5zM15 5H1v8.5a.5.5 0 0 0 .5.5h13a.5.5 0 0 0 .5-.5z" />
                </svg>
                <span class="fw-semibold">@Model.Year</span>
            </span>

            <span class="d-flex align-items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16">
                    <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187z" />
                </svg>
                <span class="fw-semibold">
                    @if (avgRating > 0)
                    {
                        @(avgRating.ToString("0.0") + " / 5")
                    }
                    else
                    {
                        <span>No ratings yet</span>
                    }
                </span>
            </span>
        </div>

        @if (genres.Any())
        {
            <div class="d-flex flex-wrap gap-2 mb-3">
                @foreach (var genre in genres)
                {
                    <span class="badge bg-light text-dark px-3 py-2 rounded-pill shadow-sm">@genre</span>
                }
            </div>
        }
        else
        {
            <div class="text-light mb-3">No genres listed.</div>
        }

        <p class="lead mb-3 hero-description">@Model.Description</p>

        @if (currentUserId != null)
        {
            if (!isFavorite)
            {
                <form asp-controller="User" asp-action="AddFavorite" method="post" class="d-inline">
                    <input type="hidden" name="movieId" value="@Model.Id" />
                    <button type="submit" class="btn btn-outline-light">Add to Favorites</button>
                </form>
            }
            else
            {
                <form asp-controller="User" asp-action="RemoveFavorite" method="post" class="d-inline">
                    <input type="hidden" name="movieId" value="@Model.Id" />
                    <button type="submit" class="btn btn-danger">Remove from Favorites</button>
                </form>
            }
        }
    </div>
</section>

<div>
    <h4>Reviews</h4>
    <hr />
    @if (Model.Comments != null && Model.Comments.Any())
    {
        foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
        {
            <div class="mb-3 p-3 border rounded bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <strong>@(comment.User?.UserName ?? "Unknown user") @(comment.Rating)/5</strong>
                    <div>
                        <small class="text-muted me-2">@comment.CreatedAt.ToString("MMMM dd, yyyy")</small>

                        @if (comment.UserId == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value)
                        {
                            <form asp-action="DeleteComment" method="post" class="d-inline">
                                <input type="hidden" name="id" value="@comment.Id" />
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this comment?');">Delete</button>
                            </form>
                        }
                    </div>
                </div>
                <p class="mb-0">@comment.Text</p>
            </div>
        }
    }
    else
    {
        <p class="text-muted">No reviews yet for this film.</p>
    }
</div>

<div>
    <a asp-action="Review" asp-route-id="@Model?.Id">Review</a> |
    <a asp-action="Back">Back</a>
</div>

@section Styles {
    <style>
        .movie-hero {
            min-height: 540px;
            aspect-ratio: 16 / 9;
        }

        .hero-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(85%);
        }

        .hero-overlay {
            position: absolute;
            inset: 0;
            z-index: 1;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.6) 100%);
            pointer-events: none;
        }

        .hero-content {
            position: absolute;
            bottom: 2rem;
            left: 2rem;
            right: 2rem;
            z-index: 2;
            max-width: 70%;
        }

        .hero-description {
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .hero-meta svg {
            opacity: 0.9;
        }

        @@media (max-width: 768px) {
            .hero-content {
                max-width: 100%;
            }

            .hero-image {
                height: auto;
            }

            .movie-hero {
                min-height: 360px;
            }
        }
    </style>
}
